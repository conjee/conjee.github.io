---
title: "Transparent Proxy on Raspberry Pi"
excerpt: "A log of efforts at setting up a Raspberry Pi-based wireless router that automatically redirects overseas traffic to a remote proxy server"
sitemap: false
permalink: /transparent-proxy-on-raspberry-pi.html
---

## The Problem

Client side proxy configuration is troublesome on some devices, e.g. the Nintendo 3DS.

## Solution Overview

We will be using a Raspberry Pi 3 as an Access Point (which itself obtains Internet connection on Ethernet cable).

iptables and ipset will be used to route TCP packets from guests.

## Limitations

1. Wifi Adapter
2. Software NAT

## Setup Walkthrough

### Make Pi a wireless router

References:

- [Page on Official Documentation](https://www.raspberrypi.org/documentation/configuration/wireless/access-point.md#internet-sharing)
- [This Blog Post](https://frillip.com/using-your-raspberry-pi-3-as-a-wifi-access-point-with-hostapd/)

In `/etc/network/interfaces`:

```
allow-hotplug wlan0
iface wlan0 inet static  
    address 172.16.0.1
    netmask 255.240.0.0
    network 172.16.0.0/12
    broadcast 172.31.255.255
```

In `/etc/dnsmasq.conf`:

```
interface=wlan0      # Use the require wireless interface - usually wlan0
  listen-address=172.16.0.1
  bind-interfaces
  server=8.8.8.8
  domain-needed
  bogus-priv
  dhcp-range=172.16.0.2,172.31.255.254,255.240.0.0,24h
```

In `/etc/hostapd/hostapd.conf`:

```
interface=wlan0
driver=nl80211
ssid=YOUR-SSID
hw_mode=g
channel=7
ieee80211n=1
wmm_enabled=1
ht_capab=[HT40][SHORT-GI-20][DSSS_CCK-40]
macaddr_acl=0
auth_algs=1
ignore_broadcast_ssid=0
wpa=2
wpa_passphrase=YOUR-PASSWORD
wpa_key_mgmt=WPA-PSK
wpa_pairwise=TKIP
rsn_pairwise=CCMP
```

### Routing and Forwarding

```
curl 'http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest' | grep ipv4 | grep CN | awk -F\| '{ printf("%s/%d\n", $4, 32-log($5)/log(2)) }' > chnroute.txt
ipset -N chnroute
for ip in $(cat '/home/peter/shadowsocks/chnroute.txt'); do
  ipset add chnroute $ip
done
```

```
# Generated by iptables-save v1.4.21 on Sat Jul 29 07:14:45 2017
*mangle
:PREROUTING ACCEPT [797:93730]
:INPUT ACCEPT [785:92199]
:FORWARD ACCEPT [29:2661]
:OUTPUT ACCEPT [699:99277]
:POSTROUTING ACCEPT [734:102358]
:SHADOWSOCKS - [0:0]
:SHADOWSOCKS_MARK - [0:0]
-A PREROUTING -j SHADOWSOCKS
-A OUTPUT -j SHADOWSOCKS_MARK
-A SHADOWSOCKS -d 0.0.0.0/8 -p udp -j RETURN
-A SHADOWSOCKS -d 10.0.0.0/8 -p udp -j RETURN
-A SHADOWSOCKS -d 127.0.0.0/8 -p udp -j RETURN
-A SHADOWSOCKS -d 169.254.0.0/16 -p udp -j RETURN
-A SHADOWSOCKS -d 172.16.0.0/12 -p udp -j RETURN
-A SHADOWSOCKS -d 192.168.0.0/16 -p udp -j RETURN
-A SHADOWSOCKS -d 224.0.0.0/4 -p udp -j RETURN
-A SHADOWSOCKS -d 240.0.0.0/4 -p udp -j RETURN
-A SHADOWSOCKS -p udp -m set ! --match-set chnroute dst -m udp --dport 53 -j TPROXY --on-port 1080 --on-ip 127.0.0.1 --tproxy-mark 0x1/0x1
-A SHADOWSOCKS_MARK -p udp -m udp --dport 53 -j MARK --set-xmark 0x1/0xffffffff
COMMIT
# Completed on Sat Jul 29 07:14:45 2017
# Generated by iptables-save v1.4.21 on Sat Jul 29 07:14:45 2017
*nat
:PREROUTING ACCEPT [774:146854]
:INPUT ACCEPT [1194:160332]
:OUTPUT ACCEPT [1493:550998]
:POSTROUTING ACCEPT [365:25588]
:SHADOWSOCKS - [0:0]
-A PREROUTING -p tcp -j SHADOWSOCKS
-A POSTROUTING -o eth0 -j MASQUERADE
-A SHADOWSOCKS -d /32 -j RETURN
-A SHADOWSOCKS -d 0.0.0.0/8 -j RETURN
-A SHADOWSOCKS -d 10.0.0.0/8 -j RETURN
-A SHADOWSOCKS -d 127.0.0.0/8 -j RETURN
-A SHADOWSOCKS -d 169.254.0.0/16 -j RETURN
-A SHADOWSOCKS -d 172.16.0.0/12 -j RETURN
-A SHADOWSOCKS -d 192.168.0.0/16 -j RETURN
-A SHADOWSOCKS -d 224.0.0.0/4 -j RETURN
-A SHADOWSOCKS -d 240.0.0.0/4 -j RETURN
-A SHADOWSOCKS -p tcp -m set --match-set chnroute dst -j RETURN
-A SHADOWSOCKS -p tcp -j REDIRECT --to-ports 1080
COMMIT
# Completed on Sat Jul 29 07:14:45 2017
# Generated by iptables-save v1.4.21 on Sat Jul 29 07:14:45 2017
*filter
:INPUT ACCEPT [230792:214433569]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [250187:213652032]
-A FORWARD -i eth0 -o wlan0 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i wlan0 -o eth0 -j ACCEPT
COMMIT
# Completed on Sat Jul 29 07:14:45 2017
```

```
sudo ip route add local default dev lo table 100
sudo ip rule add fwmark 1 lookup 100
```

### Application

Compile from source

- Import public key

Configuration

- Listen on 0.0.0.0:port
